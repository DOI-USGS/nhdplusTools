<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Network Attributes • nhdplusTools</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Advanced Network Attributes">
<meta property="og:description" content="nhdplusTools">
<meta property="og:image" content="https://usgs-r.github.io/nhdplusTools/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">nhdplusTools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/nhdplusTools.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/advanced_network.html">Advanced Network Attributes</a>
    </li>
    <li>
      <a href="../articles/nhdplushr.html">Working with NHDPlusHR</a>
    </li>
    <li>
      <a href="../articles/plot_nhdplus.html">Plotting with nhdplusTools</a>
    </li>
    <li>
      <a href="../articles/point_indexing.html">Indexing and Referencing</a>
    </li>
    <li>
      <a href="../articles/US_data.html">U.S. Data and Package Basics</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/usgs-r/nhdplusTools/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Advanced Network Attributes</h1>
                        <h4 data-toc-skip class="author"><a href="mailto:dblodgett@usgs.gov" class="email">dblodgett@usgs.gov</a></h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/usgs-r/nhdplusTools/blob/HEAD/vignettes/advanced_network.Rmd" class="external-link"><code>vignettes/advanced_network.Rmd</code></a></small>
      <div class="hidden name"><code>advanced_network.Rmd</code></div>

    </div>

    
    
<div class="section level4">
<h4 id="terminology">Terminology<a class="anchor" aria-label="anchor" href="#terminology"></a>
</h4>
<p>The terms used below are derived from concepts of <a href="https://en.wikipedia.org/wiki/Graph_theory" class="external-link">graph theory</a>, the <a href="http://opengeospatial.github.io/HY_Features/" class="external-link">HY_Features</a> data model, and the <a href="https://www.epa.gov/waterdata/nhdplus-national-hydrography-dataset-plus" class="external-link">NHDPlus</a> data model. Many of the concepts here are also presented in: <a href="https://doi.org/10.1016/j.envsoft.2020.104927" class="external-link">Mainstems: A logical data model implementing <em>mainstem</em> and <em>drainage</em> basin feature types based on WaterML2 Part 3: HY Features concepts</a>.</p>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The NHDPlus data model includes many ‘value added attributes’ (VAA). This vignette discusses a core set of VAA’s that <code>nhdplusTools</code> can create from readily available hydrograhic inputs. The vignette begins with a background needed to understand what these attributes are, and then demonstrates how to create them based on some basic input data. These attributes are documented in the <a href="https://www.epa.gov/waterdata/nhdplus-national-hydrography-dataset-plus" class="external-link">NHDPlus manual</a>, and every effort has been made to faithfully implement their meaning.</p>
<p>While the <code>nhdplusTools</code> package contains other functions to generate network attributes, (e.g. <code><a href="../reference/get_pfaf.html">get_pfaf()</a></code> for Pfafstetter codes and <code><a href="../reference/get_streamorder.html">get_streamorder()</a></code> for stream orders) this vignette focuses on the advanced network VAAs from the NHDPlus data model that revolve around the <strong>hydrosequence</strong> and <strong>levelpath</strong>.</p>
<div class="section level3">
<h3 id="representing-network-topology">Representing Network Topology<a class="anchor" aria-label="anchor" href="#representing-network-topology"></a>
</h3>
<p>A network of flowpaths can be represented as an edge-to-edge (e.g. edge list) or edge-node topology. An edge list only expresses the connectivity between <em>edges</em> (flowpaths in the context of rivers), requiring <em>nodes</em> (confluences in the context of rivers) to be inferred.</p>
<p>As of 2/2022 <code>nhdplusTools</code> works on edge list representations only. The table and simple graphics below depict both an edge-node and edge-to-edge topology.</p>
<pre><code><span class="co">#&gt;  ID toID fromnode tonode</span>
<span class="co">#&gt;   1    3       N1     N3</span>
<span class="co">#&gt;   2    3       N2     N3</span>
<span class="co">#&gt;   3   NA       N3     N4</span></code></pre>
<div class="figure" style="text-align: center">
<img src="advanced_network_files/figure-html/node-1.png" alt="In an edge-node topology, edges are directed to nodes which are then directed to other edges. An edge-to-edge toplogy does not have intervening nodes." width="45%"><img src="advanced_network_files/figure-html/node-2.png" alt="In an edge-node topology, edges are directed to nodes which are then directed to other edges. An edge-to-edge toplogy does not have intervening nodes." width="45%"><p class="caption">
In an edge-node topology, edges are directed to nodes which are then directed to other edges. An edge-to-edge toplogy does not have intervening nodes.
</p>
</div>
<p>The “toID” of a terminal flowpath can be either NA or, by convention, 0. Using 0 is preferred within <code>nhdplusTools</code> but both are handled in most cases. Further, as long as 0 is not in the set of IDs, there is little practical difference.</p>
<p>In <code>nhdplusTools</code>, edge-to-edge topology is referred to with “comid and tocomid” attributes, or a more general, “ID and toID” depending on the function in question.</p>
</div>
<div class="section level3">
<h3 id="hydrosequence">Hydrosequence<a class="anchor" aria-label="anchor" href="#hydrosequence"></a>
</h3>
<div class="figure" style="text-align: center">
<img src="advanced_network_files/figure-html/sort-1.png" alt="Smaller 'hydrosequence' values are gaurunteed to be downstream of larger values along connected paths." width="288"><p class="caption">
Smaller ‘hydrosequence’ values are gaurunteed to be downstream of larger values along connected paths.
</p>
</div>
<p>The NHDPlus data model includes an attribute called <em>hydrosequence</em> that is functionally a <a href="https://en.wikipedia.org/wiki/Topological_sorting" class="external-link">topological sort</a> of the flowpath network. It provides an integer identifier guaranteed to decrease in the downstream direction. For flowpaths that are not connected by a single direction navigation (e.g. parallel tributaries) the hydrosequence has no significance. However, when two flowpaths have a direct navigation, the downstream flowpath will always have the smaller hydrosequence. <code>nhdplusTools</code> supports creation of hydrosequence with the <code><a href="../reference/get_sorted.html">get_sorted()</a></code> function.</p>
<p>It is hard to overstate the importance of hydrosequence as <em>any</em> function that requires understanding upstream-downstream relationships requires a sorted version of the flowpath network. In the NHDPlus data model, a edge-list topology is stored in the form of a hydrosequence and ‘to hydrosequence’ attribute. The equivalent is available in <code>nhdplusTools</code>, but does not use the to hydrosequence convention, preferring the primary identifier (ID or comid) and an accompanying toID/tocomid.</p>
</div>
<div class="section level3">
<h3 id="level-path">Level Path<a class="anchor" aria-label="anchor" href="#level-path"></a>
</h3>
<div class="figure" style="text-align: center">
<img src="advanced_network_files/figure-html/lp-1.png" alt="Levelpath values are constant along mainstem paths and are derived from the hydrosequence of their outlet flowline." width="288"><p class="caption">
Levelpath values are constant along mainstem paths and are derived from the hydrosequence of their outlet flowline.
</p>
</div>
<p>A level path is derived from “stream level” which assigns an integer value to mainstem rivers from outlet up the network (see NHDPlus documentation for more). Rivers terminating to the ocean are given level 1 and this level extends all the way to the headwaters. Rivers terminating in level 1 rivers are given level 2, and so on.</p>
<p>“Stream leveling”, then, is the process of establishing uniquely identified “level paths” through a stream network. This is accomplished with a set of rules that determine which tributary should be considered dominant at every confluence to establish the “mainstem rivers” for each “drainage basin” in a network. <code>nhdplusTools</code> supports creation of streamlevel with the <code><a href="../reference/get_streamlevel.html">get_streamlevel()</a></code> function, and the creation of level path with <code>get_levelpath()</code>. The convention used in NHDPlus is to assign the levelpath as the hydrosequence of the path’s outlet.</p>
<p>See <a href="https://doi.org/10.1016/j.envsoft.2020.104927" class="external-link">Mainstems: A logical data model implementing <em>mainstem</em> and <em>drainage</em> basin feature types based on WaterML2 Part 3: HY Features concepts</a> for an in depth discussion of these concepts.</p>
</div>
<div class="section level3">
<h3 id="other-derived-network-attributes">Other Derived Network Attributes<a class="anchor" aria-label="anchor" href="#other-derived-network-attributes"></a>
</h3>
<p>A number of additional attributes can be derived once <code>levelpath</code> and <code>hydrosequence</code> are established. These include:</p>
<ol style="list-style-type: decimal">
<li>
<strong>terminal path (<code>terminalpa</code>)</strong>: the identifier (hydrosequence or primary id) of the terminal flowpath of network.</li>
<li>
<strong>up hydrosequence (<code>uphydroseq</code>)</strong>: the identifier of the upstream flowpath on the mainstem</li>
<li>
<strong>down hydrosequence (<code>dnhydroseq</code>)</strong>: the identifier of the downstream flowpath on the mainstem</li>
<li>
<strong>up level path (<code>uplevelpat</code>)</strong>: the identifier of the next upstream levelpath on the mainstem</li>
<li>
<strong>down level path (<code>dnlevelpat</code>)</strong>: the identifier of the next downstream levelpath on the mainstem</li>
<li>
<strong>path length (<code>pathlength</code>)</strong>: The distance to the network outlet downstream along the main path.</li>
<li>
<strong>total drainage area (<code>totdasqkm</code>):</strong> Total accumulated area from upstream flowpath’s catchment area.</li>
<li>
<strong>arbolate sum (<code>arbolatsu</code>):</strong> The total accumulated length of upstream flowpaths.</li>
<li>
<strong>terminal flag (<code>terminalfl</code>):</strong> A simple 0 or 1 indicating whether a flowpath is a terminal path or not.</li>
</ol>
</div>
<div class="section level3">
<h3 id="required-base-attributes">Required Base Attributes<a class="anchor" aria-label="anchor" href="#required-base-attributes"></a>
</h3>
<p>Creating levelpath and hydrosequence identifiers requires a set of base attributes that include:</p>
<ol style="list-style-type: decimal">
<li><p><strong><code>fromnode</code> / <code>tonode</code></strong> or <strong><code>ID</code> / <code>toID</code></strong>: from and to nodes can be used to generate an edge to edge flowpath topology. Note that “ID/toID” is “comid/tocomid” in some <code>nhdplusTools</code> functions.</p></li>
<li><p><strong><code>length</code>:</strong> a length is required for each flowpath in the network to determine a flow distance, and, if using the arbolate sum for stream leveling.</p></li>
<li><p><strong><code>area</code>:</strong> the local drainage area of each flowpath is useful in many contexts but is primarily used to calculate total drainage area.</p></li>
<li><p><strong><code>weight</code>:</strong> a weight metric is required for stream leveling to determine the dominant upstream flowpath. In the NHD, the arbolate sum is used however alternative metrics (e.g. total drainage area) can be used instead.</p></li>
<li><p><strong><code>nameID</code>:</strong> Many times it is preferable to follow a consistently named path (e.g. GNIS) rather a strict physical weight when stream leveling. In these cases a <code>nameID</code> can be provided.</p></li>
<li><p><strong><code>divergence</code>:</strong> in order to create a [many:1] upstream to downstream topology, diverted paths must be labeled as such. This attribute, is 0 for normal (already [many:1]) connections, 1 for the main path through a divergence, and 2 for any diverted path.</p></li>
<li><p><strong>feature type (<code>ftype</code>):</strong> used to determine whether a feature is a stream, a coastal path, or some other type of connected network feature. This is the ‘ftype’ in the NHD data model.</p></li>
</ol>
<p><strong>NOTE</strong>: The <code>nhdplusTools</code> package does not support creation of all attributes discussed here, however, those that are not directly supported can be created based on basic transformations of attributes that <code>nhdplusTools</code> does support.</p>
</div>
</div>
<div class="section level2">
<h2 id="a-visual-introduction-to-the-advanced-network-attributes">A visual introduction to the advanced network attributes<a class="anchor" aria-label="anchor" href="#a-visual-introduction-to-the-advanced-network-attributes"></a>
</h2>
<p>To illustrate the above concepts and attributes, we’ll start with the “New Hope” demo data included in the <code>nhdplusTools</code> package and add a tocomid attribute based on the edge-node topology included in the data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Import data</span>
<span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/new_hope_data.R"</span>, package <span class="op">=</span> <span class="st">"nhdplusTools"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Strip the data back to the required base attributes</span>
<span class="va">fpath</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_tocomid.html">get_tocomid</a></span><span class="op">(</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">new_hope_flowline</span>, <span class="va">COMID</span>, <span class="va">FromNode</span>, <span class="va">ToNode</span>, <span class="va">Divergence</span>, <span class="va">FTYPE</span>,
                <span class="va">AreaSqKM</span>, <span class="va">LENGTHKM</span>, <span class="va">GNIS_ID</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># Print</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fpath</span> <span class="op">&lt;-</span> <span class="fu">select</span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="st">"LINESTRING"</span><span class="op">)</span>, 
                     <span class="op">-</span><span class="va">tonode</span>, <span class="op">-</span><span class="va">fromnode</span>, <span class="op">-</span><span class="va">divergence</span>, <span class="op">-</span><span class="va">ftype</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Simple feature collection with 6 features and 5 fields</span>
<span class="co">#&gt; Geometry type: LINESTRING</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 1517192 ymin: 1555954 xmax: 1518819 ymax: 1557990</span>
<span class="co">#&gt; CRS:           +proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs</span>
<span class="co">#&gt;     comid tocomid areasqkm lengthkm gnis_id                           geom</span>
<span class="co">#&gt; 1 8893864 8894334   4.8123    3.245  991288 LINESTRING (1518702 1557298...</span>
<span class="co">#&gt; 2 8894490 8894336   0.0000    0.002  991288 LINESTRING (1517194 1556000...</span>
<span class="co">#&gt; 3 8894494 8894490   0.0090    0.102  991288 LINESTRING (1517288 1556038...</span>
<span class="co">#&gt; 4 8894334 8894492   0.4284    0.073  991288 LINESTRING (1517349 1556090...</span>
<span class="co">#&gt; 5 8894492 8894494   0.0018    0.008  991288 LINESTRING (1517295 1556041...</span>
<span class="co">#&gt; 6 8893850 8893864   0.4059    0.954  991288 LINESTRING (1518668 1557990...</span></code></pre></div>
<div class="section level4">
<h4 id="hydrosequence-and-terminal-id">Hydrosequence and terminal ID<a class="anchor" aria-label="anchor" href="#hydrosequence-and-terminal-id"></a>
</h4>
<p>After removing attributes used to generate the <code>tocomid</code> attribute, we have a <code>comid</code> and <code>tocomid</code> relation representing the connectivity of the network as well as attributes required to generate a sorted network with <code><a href="../reference/get_sorted.html">get_sorted()</a></code></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fpath</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_sorted.html">get_sorted</a></span><span class="op">(</span><span class="va">fpath</span>, split <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Simple feature collection with 6 features and 6 fields</span>
<span class="co">#&gt; Geometry type: LINESTRING</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 1505349 ymin: 1554873 xmax: 1508920 ymax: 1558708</span>
<span class="co">#&gt; CRS:           +proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs</span>
<span class="co">#&gt;     comid tocomid areasqkm lengthkm gnis_id terminalID</span>
<span class="co">#&gt; 1 8898302 8896658   0.1521    0.182  983820    8897784</span>
<span class="co">#&gt; 2 8896658 8896656   1.1871    1.371  983820    8897784</span>
<span class="co">#&gt; 3 8896656 8896624   3.8565    2.638  983820    8897784</span>
<span class="co">#&gt; 4 8896664 8896624   1.3770    1.641            8897784</span>
<span class="co">#&gt; 5 8896624 8896570   1.3392    1.167  983820    8897784</span>
<span class="co">#&gt; 6 8896572 8896570   1.5561    1.767            8897784</span>
<span class="co">#&gt;                             geom</span>
<span class="co">#&gt; 1 LINESTRING (1505349 1555718...</span>
<span class="co">#&gt; 2 LINESTRING (1505455 1555570...</span>
<span class="co">#&gt; 3 LINESTRING (1506375 1554873...</span>
<span class="co">#&gt; 4 LINESTRING (1507786 1554903...</span>
<span class="co">#&gt; 5 LINESTRING (1508236 1556343...</span>
<span class="co">#&gt; 6 LINESTRING (1508311 1558708...</span></code></pre></div>
<p>The <code><a href="../reference/get_sorted.html">get_sorted()</a></code> function sorts the flowpaths such that headwaters come first and the terminal flowpath last. Additionally, it produces a <code>terminalID</code> representing the outlet ID of the network. If multiple terminal networks had been provided, the <code>terminalID</code> would allow us to group the data by complete sub networks (a convenient parallelization scheme).</p>
<p>In contrast to the NHD, where the terminal path is identified by the hydrosequence ID of the outlet flowpath (meaning the outlet of a level path is left to a user to generate), <code>nhdplusTools</code> uses the more stable primary ID for identifying outlets to allow the hydrosequence / topo sort attribute to be generated and discarded as needed.</p>
<p>We can visualize this sorting by assigning a temporary “hydrosequence” value to the sorted network row wise. Here, we assign the first rows in the sorted set to large values and the last rows to small values in line with the hydrosequence order convention in NHDPlus.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fpath</span><span class="op">[</span><span class="st">'hydrosequence'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">[</span><span class="st">'hydrosequence'</span><span class="op">]</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<p><img src="advanced_network_files/figure-html/unnamed-chunk-4-1.png" width="288" style="display: block; margin: auto;"></p>
</div>
<div class="section level4">
<h4 id="level-path-and-outlet-id">Level Path and outlet ID<a class="anchor" aria-label="anchor" href="#level-path-and-outlet-id"></a>
</h4>
<p>To generate a levelpath attribute, a “physical” weight is needed to determine the upstream mainstem at divergences. For this example, we’ll follow the NHD convention and calculate the arbolate sum explicitly. The <code><a href="../reference/get_levelpaths.html">get_levelpaths()</a></code> function will add arbolate sum internally if no weight is explicitly defined.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Rename and compute weight</span>
<span class="va">fpath</span><span class="op">[[</span><span class="st">"arbolatesum"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calculate_arbolate_sum.html">calculate_arbolate_sum</a></span><span class="op">(</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">fpath</span>, 
                ID <span class="op">=</span> <span class="va">comid</span>, toID <span class="op">=</span> <span class="va">tocomid</span>, length <span class="op">=</span> <span class="va">lengthkm</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="va">fpath</span><span class="op">$</span><span class="va">arbolatesum</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<p><img src="advanced_network_files/figure-html/unnamed-chunk-5-1.png" width="384" style="display: block; margin: auto;"></p>
<p>A <code>nameID</code> identifier can also be provided to override the physical <code>weight</code> when a “smaller” river has the same name. There is an optional <code>override_factor</code> parameter that signifies if the physical weight is <code>override_factor</code> times (e.g. 5) larger on an unnamed or differently named upstream path, the physical weight will be used in favor of the named ID.</p>
<p>As mentioned above, <code>nhdplusTools</code> favors more general naming of to/from nodes then the NHD, so names are modified accordingly.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Get levelpaths</span>
<span class="va">lp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_levelpaths.html">get_levelpaths</a></span><span class="op">(</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">fpath</span>, 
                ID <span class="op">=</span> <span class="va">comid</span>, toID <span class="op">=</span> <span class="va">tocomid</span>, 
                nameID <span class="op">=</span> <span class="va">gnis_id</span>, weight <span class="op">=</span> <span class="va">arbolatesum</span><span class="op">)</span>, 
  status <span class="op">=</span> <span class="cn">FALSE</span>, override_factor <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>

<span class="co"># Print</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fpath</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="va">lp</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"comid"</span> <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Simple feature collection with 6 features and 11 fields</span>
<span class="co">#&gt; Geometry type: LINESTRING</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 1505349 ymin: 1554873 xmax: 1508920 ymax: 1558708</span>
<span class="co">#&gt; CRS:           +proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs</span>
<span class="co">#&gt;     comid tocomid areasqkm lengthkm gnis_id terminalID hydrosequence</span>
<span class="co">#&gt; 1 8898302 8896658   0.1521    0.182  983820    8897784           746</span>
<span class="co">#&gt; 2 8896658 8896656   1.1871    1.371  983820    8897784           745</span>
<span class="co">#&gt; 3 8896656 8896624   3.8565    2.638  983820    8897784           744</span>
<span class="co">#&gt; 4 8896664 8896624   1.3770    1.641            8897784           743</span>
<span class="co">#&gt; 5 8896624 8896570   1.3392    1.167  983820    8897784           742</span>
<span class="co">#&gt; 6 8896572 8896570   1.5561    1.767            8897784           741</span>
<span class="co">#&gt;   arbolatesum outletID topo_sort levelpath                           geom</span>
<span class="co">#&gt; 1       0.182  8894348       746       725 LINESTRING (1505349 1555718...</span>
<span class="co">#&gt; 2       1.553  8894348       745       725 LINESTRING (1505455 1555570...</span>
<span class="co">#&gt; 3       4.191  8894348       744       725 LINESTRING (1506375 1554873...</span>
<span class="co">#&gt; 4       1.641  8896664       743       743 LINESTRING (1507786 1554903...</span>
<span class="co">#&gt; 5       6.999  8894348       742       725 LINESTRING (1508236 1556343...</span>
<span class="co">#&gt; 6       1.767  8896572       741       741 LINESTRING (1508311 1558708...</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">[</span><span class="st">"topo_sort"</span><span class="op">]</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">[</span><span class="st">"levelpath"</span><span class="op">]</span>, key.pos <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<p><img src="advanced_network_files/figure-html/levelpath-1.png" width="45%" style="display: block; margin: auto;"><img src="advanced_network_files/figure-html/levelpath-2.png" width="45%" style="display: block; margin: auto;"></p>
<p>Note that the <code>get_levelpaths</code> adds an <code>outletID</code> signifying the overall network outlet ID (not topo sort / hydrosequence) by primary identifier.</p>
<p>Finally, let’s visualize these advanced VAAs!</p>
<p>In the below animation, each newly added level path is shown in blue, with the outlet flowpath colored in red. Remembering that <code><a href="../reference/get_sorted.html">get_sorted()</a></code> sorts flowpaths such that headwaters come first and the terminal flowpaths last we invert the network so that level paths fill in from outlet to head waters. For clarity, only levelpaths with more than 2 flowlines are shown.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Invert plotting order</span>
<span class="va">fpath</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="va">topo_sort</span><span class="op">)</span> 

<span class="co"># Level Paths with more then 2 flowpaths</span>
<span class="va">lp</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="va">levelpath</span><span class="op">)</span> <span class="op">%&gt;%</span>
<span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">2</span><span class="op">)</span> 

<span class="co"># Unique Level Path ID</span>
<span class="va">lp</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">lp</span><span class="op">$</span><span class="va">levelpath</span><span class="op">)</span>

<span class="co"># Terminal Flowpath </span>
<span class="va">terminal_fpath</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="va">comid</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">terminalID</span><span class="op">)</span>

<span class="va">gif_file</span> <span class="op">&lt;-</span> <span class="st">"levelpath.gif"</span>

<span class="fu">gifski</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gifski/man/gifski.html" class="external-link">save_gif</a></span><span class="op">(</span><span class="op">{</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">lp</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">lp_plot</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="va">levelpath</span> <span class="op">==</span> <span class="va">lp</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>

    <span class="va">outlet_plot</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">lp_plot</span>, <span class="va">comid</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">outletID</span><span class="op">)</span>

    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">fpath</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">0.5</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">terminal_fpath</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"red"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="va">levelpath</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">lp</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">lp_plot</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"blue"</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">outlet_plot</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span>, lwd <span class="op">=</span> <span class="fl">1.5</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>, <span class="va">gif_file</span>, delay <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
<span class="co">#&gt; [1] "C:\\Users\\dblodgett\\active_code\\nhdplusTools\\vignettes\\levelpath.gif"</span>

<span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html" class="external-link">include_graphics</a></span><span class="op">(</span><span class="va">gif_file</span><span class="op">)</span></code></pre></div>
<p><img src="levelpath.gif" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<p>This entire process of sorting the network and building hydrosequence, levelpath, and derivative variables is wrapped in the <code><a href="../reference/add_plus_network_attributes.html">add_plus_network_attributes()</a></code> function to provide performance and simplicity. It supports paralellization and will print status updates in the case when the input network is very large. <code><a href="../reference/add_plus_network_attributes.html">add_plus_network_attributes()</a></code> returns NHDPlus attribute names (truncated per shapefile rules as is done in the NHDPlus database).</p>
<p>The <code>terminalpa</code>, <code>levelpathi</code>, <code>dnlevelpat</code>, and <code>dnhydroseq</code> attributes are <code>hydroseq</code> identifiers as is the convention in NHDPlus, <em>not</em> primary identifiers (<code>comid</code>s) as is returned from the base functions demonstrated above.</p>
<p>As of 2/2022, this function does not support the up level path (<code>uplevelpat</code>) or up hydrosequence (<code>uphydroseq</code>) noted in “Other Derived Network Attributes”.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/add_plus_network_attributes.html">add_plus_network_attributes</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">fpath</span>, <span class="va">comid</span>, <span class="va">tocomid</span>, <span class="va">lengthkm</span>, <span class="va">areasqkm</span>, 
                                               nameID <span class="op">=</span> <span class="va">gnis_id</span><span class="op">)</span>, status <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Simple feature collection with 6 features and 14 fields</span>
<span class="co">#&gt; Geometry type: LINESTRING</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 1514059 ymin: 1551922 xmax: 1518746 ymax: 1554515</span>
<span class="co">#&gt; CRS:           +proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs</span>
<span class="co">#&gt;     comid tocomid lengthkm areasqkm nameID  weight terminalpa hydroseq</span>
<span class="co">#&gt; 1 8897784       0    1.394   3.5973 991039 577.376          1        1</span>
<span class="co">#&gt; 2 8894360 8897784    0.045   0.0126        575.982          1        2</span>
<span class="co">#&gt; 3 8894356 8894360    1.073   0.8622 991037 435.152          1      151</span>
<span class="co">#&gt; 4 8894354 8894356    0.507   0.2772 991037 426.711          1      159</span>
<span class="co">#&gt; 5 8894350 8894354    1.463   1.0737 987350  10.910          1      741</span>
<span class="co">#&gt; 6 8893884 8894350    1.793   2.1402 987350   9.447          1      742</span>
<span class="co">#&gt;   levelpathi pathlength dnlevelpat dnhydroseq totdasqkm terminalfl</span>
<span class="co">#&gt; 1          1      0.000          0          0  595.3383          1</span>
<span class="co">#&gt; 2          1      1.394          1          1  591.7410          0</span>
<span class="co">#&gt; 3          1      1.439          1          2  437.1840          0</span>
<span class="co">#&gt; 4          1      2.512          1        151  428.0076          0</span>
<span class="co">#&gt; 5        741      3.019          1        159   10.9800          0</span>
<span class="co">#&gt; 6        741      4.482        741        741    9.9063          0</span>
<span class="co">#&gt;                             geom</span>
<span class="co">#&gt; 1 LINESTRING (1514515 1553152...</span>
<span class="co">#&gt; 2 LINESTRING (1514541 1553188...</span>
<span class="co">#&gt; 3 LINESTRING (1515465 1553664...</span>
<span class="co">#&gt; 4 LINESTRING (1515773 1554056...</span>
<span class="co">#&gt; 5 LINESTRING (1517098 1554192...</span>
<span class="co">#&gt; 6 LINESTRING (1518746 1554515...</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by David Blodgett, Mike Johnson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
