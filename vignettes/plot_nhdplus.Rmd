---
title: "Plotting with nhdplusTools"
author: "dblodgett@usgs.gov"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{pkgdown}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width=6, 
  fig.height=4
)
options(scipen = 9999)
```
```{r data_dir_setup, echo=FALSE, include=FALSE}
dir.create("./data_dir")
```

# Plotting with nhdplusTools

The goal of this vignette is to demonstrate a simple and lightweight approach to building maps with NHDPlus data. 

## Getting Data

For this example, we'll start from an outlet NWIS Site. Note that other options are possible with `discover_nhdplus_id` and `discover_nldi_sources`.

```{r get data}
library(sf)
library(nhdplusTools)
nwissite <- list(featureSource = "nwissite", 
                     featureID = "USGS-05428500")

flowline <- navigate_nldi(nwissite, 
                          mode = "upstreamTributaries", 
                          data_source = "")

nhdplus <- subset_nhdplus(comids = flowline$nhdplus_comid,
                          output_file = "./data_dir/nhdplus.gpkg",
                          nhdplus_data = "download",
                          overwrite = TRUE)

flowline <- read_sf(nhdplus, "NHDFlowline_Network")

upstream_nwis <- navigate_nldi(nwissite,
                               mode = "upstreamTributaries",
                               data_source = "nwissite")

basin <- get_nldi_basin(nwissite)
```

Now we have a file at the path held in the variable `nhdplus` and three `sf` `data.frame`s with contents that look like:

```{r introspect} 
st_layers(nhdplus)
names(flowline)
names(upstream_nwis)
names(basin)
class(st_geometry(flowline))
class(st_geometry(upstream_nwis))
class(st_geometry(basin))
```

Our file has four layers: network flowlines, simplified catchments, nhd area features, and nhd waterbody features. 

The flowlines have a large set of attributes from the NHDPlus dataset. And the nwis sites have a few attributes that came from the NLDI. Attributes for NWIS sites can be found using the [dataRetrieval package.](https://owi.usgs.gov/R/dataRetrieval.html)

See the NHDPlus user guide [linked here](https://www.epa.gov/waterdata/learn-more#Documentation) for more on what these layers are and what the flowline attributes entail.

## Plot Setup

At this point, we could plot these data in a few ways. The easiest may be to use [`ggmap`](https://github.com/dkahle/ggmap) and [`ggplot` `geom_sf`](https://ggplot2.tidyverse.org/reference/ggsf.html). A future version of this vignette may show how to use those. In order to maximize flexibility and make sure we understand what's going on with coordinate reference systems, the demonstration below shows how to use base R plotting with the package `prettymappr` and `rosm`. In the future, additional plotting examples using ggplot, leaflet, and other base plot options will be added here so stay tuned!

```{r plot setup, message=FALSE}
  bbox <- st_bbox(basin)
  bbox <- prettymapr::makebbox(bbox[4], bbox[3], bbox[2], bbox[1])

  prettymapr::prettymap({
    rosm::osm.plot(bbox, type = "stamenwatercolor", quiet = TRUE)
    plot(st_transform(st_geometry(basin), 3857), 
         lwd = 2, add = TRUE)
    plot(st_transform(st_geometry(flowline), 3857), 
         lwd = 1.5, col = "deepskyblue", add = TRUE)
    plot(st_transform(st_geometry(dplyr::filter(flowline,
                                                streamorde > 2)), 
                      3857), 
         lwd = 3, col = "darkblue", add = TRUE)
    plot(st_transform(st_geometry(upstream_nwis), 3857), 
         pch = 17, cex = 1.5, col = "yellow", add = TRUE)
    label_pos <- st_coordinates(st_transform(st_geometry(upstream_nwis), 3857))
    text(label_pos[,1],label_pos[,2], 
         upstream_nwis$identifier, 
         adj = c(-0.2, 0.5), cex = 0.7)
  }, drawarrow = TRUE)
``` 

```{r cleanup, echo = FALSE} 
unlink("data_dir", recursive = T)
```
